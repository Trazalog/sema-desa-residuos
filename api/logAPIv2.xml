<api xmlns="http://ws.apache.org/ns/synapse" name="logAPI" context="/arbolado/api">
	<resource methods="POST" uri-template="/tools/log/solicitudContenedor">
      <inSequence>
         <log level="custom" description="Previo db">
            <property name="formid" expression="json-eval($._post_arbol_set._put_formulario_batch_req.form_id)"/>
         </log>
         <script language="js">var payload = mc.getPayloadJSON();  mc.setProperty("ORIGINAL_PAYLOAD",JSON.stringify(payload));</script>
               <payloadFactory media-type="json" description="Instanciar form">
		       <format>    
			{
    						"_post_solicitudcontenedor":{
      									"observaciones": "$1", 
      									"usuario_app": "$2", 
      									"sotr_id": "$3"
    			}
  			}
  			</format>
                  <args>
                     <arg evaluator="json" expression="$.solicitudContenedor.observaciones"/>
                     <arg evaluator="json" expression="$.solicitudContenedor.usuario_app"/>
                     <arg evaluator="json" expression="$.solicitudContenedor.sotr_id"/>
                  </args>
               </payloadFactory>
         	<property name="messageType" value="application/json" scope="axis2"/>
               <header name="Accept" scope="transport" value="application/json"/>
               <property name="FORCE_ERROR_ON_SOAP_FAULT" value="true" scope="default" type="STRING"/>
               <call>
                  <endpoint key="logSolicitudContenedorPOST"/>
               </call>
               <log level="full" description="vamos a insertar contenedores solicitados"/>
	       <property name="setIdEnHijos_elemento_destino" value="_post_solicitudcontenedor_tipocarga_batch_req" type="STRING"/>
	       <property name="setIdEnHijos_arreglo_destino" value="_post_solicitudcontenedor_tipocarga" type="STRING"/>
               <property name="setIdEnHijos_propiedad_destino" value="soco_id" type="STRING"/>
               <property name="setIdEnHijos_id_padre" expression="json-eval($..soco_id)" type="STRING"/>
	       <script language="js" key="conf:tools/setIdEnHijos.js" function="setIdEnHijos"/>

               <header name="Accept" scope="transport" value="application/json"/>
               <property name="FORCE_ERROR_ON_SOAP_FAULT" value="true" scope="default" type="STRING"/>
               <call>
                  <endpoint key="logContenedoresSolicitadosPOST"/>
               </call>
               <log level="full" description="TODO POST guardar formulario"/>
            </default>
         </switch>
         <script language="js" description="set payload in body">mc.setPayloadJSON(JSON.parse(mc.getProperty("ORIGINAL_PAYLOAD")));</script>
         <payloadFactory media-type="json" description="Crear arbol">
            <format>     {             "_post_arbol":{      "calle": "$1",      "altura": "$2",      "manz_id": "$3",      "nombre": "$4",      "info_id": "$5",      "cens_id": "$6",      "lat": "$7",      "long": "$8",      "tipo": "$9",      "imagen":"$10",      "taza":"$11",      "barrio":"$12"      }          }            </format>
            <args>
               <arg evaluator="json" expression="$._post_arbol_set.calle"/>
               <arg evaluator="json" expression="$._post_arbol_set.altura"/>
               <arg evaluator="json" expression="$._post_arbol_set.manz_id"/>
               <arg evaluator="json" expression="$._post_arbol_set.nombre"/>
               <arg evaluator="xml" expression="get-property('vInfoId')"/>
               <arg evaluator="json" expression="$._post_arbol_set.cens_id"/>
               <arg evaluator="json" expression="$._post_arbol_set.lat"/>
               <arg evaluator="json" expression="$._post_arbol_set.long"/>
               <arg evaluator="json" expression="$._post_arbol_set.tipo"/>
               <arg evaluator="json" expression="$._post_arbol_set.imagen"/>
               <arg evaluator="json" expression="$._post_arbol_set.taza"/>
               <arg evaluator="json" expression="$._post_arbol_set.barrio"/>
            </args>
         </payloadFactory>
         <log level="full" description="Antes send"/>
         <header name="Accept" scope="transport" value="application/json"/>
         <header name="Content-type" scope="transport" value="application/json"/>
         <property name="messageType" value="application/json" scope="axis2"/>
         <property name="FORCE_ERROR_ON_SOAP_FAULT" value="true" scope="default" type="STRING"/>
         <send>
            <endpoint key="ArbolPostDSS"/>
         </send>
      </inSequence>
      <outSequence>
         <log level="full">
            <property name="MESSAGE" value="FIRST"/>
         </log>
         <payloadFactory media-type="json" description="Mensaje error">
            <format>{"response" : {&#xd;                       "resultado" : "$1" &#xd;                                    }&#xd;}</format>
            <args>
               <arg evaluator="json" expression="$.resultado.codigo"/>
            </args>
         </payloadFactory>
         <log level="custom" description="post mensaje out">
            <property name="info_id_resultado" expression="get-property('vInfoId')"/>
         </log>
         <send/>
      </outSequence>
      <faultSequence>
         <log level="custom" description="Informe de error">
            <property name="text" value="************Error Inesperado******************"/>
            <property name="code" value="1000"/>
            <property name="message" expression="get-property('ERROR_MESSAGE')"/>
         </log>
         <payloadFactory media-type="json" description="Mensaje error">
            <format>{"response" : {&#xd;                       "errorCode" : "1000"                 }&#xd;}</format>
            <args/>
         </payloadFactory>
         <property name="messageType" value="application/json" scope="axis2" type="STRING"/>
         <property name="HTTP_SC" value="404" scope="axis2" type="STRING" description="Respuesta 404"/>
         <send/>
      </faultSequence>
   </resource>
</api>
                        
